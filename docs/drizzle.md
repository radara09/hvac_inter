# Database Documentation (`drizzle/`)

This directory contains the database migrations and configuration for the project, managed by **Drizzle ORM** and **Drizzle Kit**. The database used is **Cloudflare D1** (SQLite).

## Overview

- **ORM**: [Drizzle ORM](https://orm.drizzle.team/) - A TypeScript ORM that maps your code to the database schema.
- **Migration Tool**: [Drizzle Kit](https://orm.drizzle.team/kit-docs/overview) - A CLI tool for generating and running migrations.
- **Database**: Cloudflare D1 (SQLite).

## Directory Structure

### `drizzle/` (Root)
Contains the SQL migration files generated by Drizzle Kit.
- **`0000_....sql`**: The initial migration (likely creating auth tables).
- **`0001_....sql`**, **`0002_....sql`**, etc.: Subsequent schema changes.
- **`meta/`**: Internal Drizzle Kit metadata (snapshots, journal) to track migration state.

### `drizzle.config.ts`
The configuration file for Drizzle Kit.
- **`schema`**: Points to `./worker/db/index.ts` as the source of truth for the schema.
- **`out`**: Points to `./drizzle` as the destination for generated SQL files.
- **`dialect`**: Set to `"sqlite"`.
- **`dbCredentials`**:
    - **Development**: Attempts to locate the local `.sqlite` file generated by Wrangler (`.wrangler/state/v3/d1/...`).
    - **Production**: Uses Cloudflare API credentials (`CLOUDFLARE_D1_ACCOUNT_ID`, etc.) to connect to the remote D1 database via HTTP.

## Schema Definitions

The schema is defined in TypeScript files within `worker/db/`:

### `worker/db/auth.schema.ts`
Standard Better Auth tables:
- `user`: Stores user profile (name, email, image, role).
- `session`: Stores active sessions.
- `account`: Stores OAuth accounts (e.g., Google).
- `verification`: Stores verification tokens.

### `worker/db/ac.schema.ts`
Domain-specific tables:
- **`sites`**: Represents a physical location (e.g., "Gedung A").
    - `syncEnabled`: Boolean to enable Google Sheets sync.
    - `spreadsheetUrl`: URL of the source Google Sheet.
- **`ac_units`**: Represents an AC unit.
    - `assetCode`: Unique identifier.
    - `siteId`: Foreign key to `sites`.
    - `lastServiceAt`: Timestamp of last service.
    - `nextScheduleAt`: Timestamp of next scheduled service.
- **`ac_unit_history`**: Immutable log of changes.
    - `changes`: JSON string describing what changed.
    - `userId`: Who made the change.
- **`user_sites`**: Junction table for assigning users to sites.
    - `role`: Role within the site (e.g., "member").
- **`site_email_allowlist`**: Pre-approved emails for site registration.

## Workflows

### 1. Modifying the Schema
1.  Edit the TypeScript schema files in `worker/db/*.schema.ts`.
2.  Run the generation script:
    ```bash
    bun run db:generate
    ```
    This runs `drizzle-kit generate`, which compares your TypeScript schema to the existing migrations and creates a new `.sql` file in `drizzle/`.

### 2. Applying Migrations (Local)
To apply pending migrations to your local D1 database (managed by Wrangler):
```bash
bun run db:migrate:dev
```
This executes `wrangler d1 migrations apply DB --local`.

### 3. Applying Migrations (Production)
To apply pending migrations to the remote Cloudflare D1 database:
```bash
bun run db:migrate:prod
```
This executes `wrangler d1 migrations apply DB --remote`.

### 4. Drizzle Studio
To visualize and manage your data in a GUI:
- **Local**: `bun run db:studio:dev`
- **Production**: `bun run db:studio:prod`

## Key Commands (from `package.json`)

| Command | Description |
| :--- | :--- |
| `db:generate` | Generate SQL migrations from schema changes. |
| `db:migrate:dev` | Apply migrations to local D1 database. |
| `db:migrate:prod` | Apply migrations to remote D1 database. |
| `db:studio:dev` | Open Drizzle Studio for local DB. |
| `db:studio:prod` | Open Drizzle Studio for remote DB. |
